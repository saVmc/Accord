{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="page-header">
    <h1>Messages</h1>
    <a class="btn" href="{{ url_for('new_dm') }}">+ New Conversation</a>
  </div>

  <div class="inbox-container">
    {% if threads %}
      <div class="thread-list">
        {% for t in threads %}
          {% set other_user = get_other_user(t[0], user.id) if not t[1] else None %}
          <a href="{{ url_for('dm_thread', thread_id=t[0]) }}" class="thread-item {% if t[4] > 0 %}unread{% endif %}">
            <div class="thread-avatar-container">
              {% if t[1] %}
                <div class="group-avatar">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                </div>
              {% else %}
                <img class="thread-avatar" src="{{ other_user[1] or url_for('static', filename='images/default_avatar.png') }}" alt="Avatar" />
              {% endif %}
              {% if t[4] > 0 %}
                <span class="unread-badge">{{ t[4] }}</span>
              {% endif %}
            </div>
            
            <div class="thread-content">
              <div class="thread-header">
                <h3 class="thread-name">
                  {% if t[1] %}
                    {{ t[2] or "Unnamed Group" }}
                  {% else %}
                    {{ other_user[0] if other_user else "Unknown User" }}
                  {% endif %}
                </h3>
                {% if t[5] %}
                  <span class="thread-time">{{ t[5]|sydney_time }}</span>
                {% endif %}
              </div>
              {% if t[6] %}
                <p class="thread-preview">{{ t[6][:60] }}{% if t[6]|length > 60 %}...{% endif %}</p>
              {% else %}
                <p class="thread-preview muted">No messages yet</p>
              {% endif %}
            </div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <h3>No conversations yet :(</h3>
        <p class="muted">Don't be lonely! Message someone now</p>
        <a class="btn" href="{{ url_for('new_dm') }}">New DM</a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}