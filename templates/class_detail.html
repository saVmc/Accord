{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="page-header">
    <div>
      <h1>{{ class_row[1] }}</h1>
      <p class="muted">CLASS CODE >>> <strong>{{ class_row[2] }}</strong> <<< SHARE WITH STUDENTS!!!!</p>
      <p class="muted">Teacher: {{ teacher[1] }} &lt;{{ teacher[2] }}&gt;</p>
    </div>
    <div>
      {% if user.role == 'teacher' and user.id == class_row[3] %}
        <a class="btn" href="{{ url_for('create_class') }}">+ New Class</a>
      {% endif %}
    </div>
  </div>
  <div class="grid">
    <div class="card">
      <h3>Class Description</h3>
      <p class="muted">{{ class_row[4] or "No description yet." }}</p>
      {% if user.role == 'teacher' and user.id == class_row[3] %}
        <hr style="margin:12px 0">
        <form method="POST" action="{{ url_for('edit_class', class_id=class_row[0]) }}">
          <label>Change class name</label>
          <input name="class_name" type="text" value="{{ class_row[1] }}" />
          <label>Update description</label>
          <textarea name="description" rows="4">{{ class_row[4] or "" }}</textarea>
          <button class="btn" type="submit">Save changes</button>
        </form>
      {% endif %}
    </div>
    <div class="card">
      <h3>Students ({{ students|length }})</h3>
      {% if students %}
        <ul>
          {% for s in students %}
            <li style="display: flex; align-items: center; justify-content: space-between;">
              <div style="display: flex; align-items: center; gap: 0.8rem;">
                <img class="avatar small" src="{{ s[3] or url_for('static', filename='images/default_avatar.png') }}" alt="Profile" />
                <div>
                  <div>{{ s[1] }}</div>
                  <div class="muted" style="font-size: 0.85rem;">{{ s[2] }}</div>
                </div>
              </div>
              {% if s[0] != user.id %}
                <a href="{{ url_for('start_dm', user_id=s[0]) }}" class="student-dm-button">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                  Message
                </a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No students enrolled yet :< it's very quiet here...</p>
      {% endif %}
    </div>
  </div>
<div class="card">
  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.75rem;">
    <h3 style="margin:0;">Assignments</h3>
    {% if user.role == "teacher" and user.id == class_row[3] %}
      <a class="btn ghost" href="{{ url_for('create_assignment', class_id=class_row[0]) }}">+ New Assignment</a>
    {% endif %}
  </div>

  {% if assignments %}
    <div style="display:grid; gap:0.8rem;">
      {% for a in assignments %}
        <a href="{{ url_for('assignment_detail', assignment_id=a[0]) }}" 
           class="assignment-item"
           style="display:flex; flex-direction:column; padding:0.9rem 1rem; border-radius:0.75rem; border:1px solid #0fb9af; background:#0f2648; text-decoration:none; transition:all 0.15s ease;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem;">
            <h4 style="margin:0; font-weight:600; color:#e2e3e7;">{{ a[2] }}</h4>
            <span style="font-size:0.8rem; background:#0f2648; color:#e2e3e7; padding:0.2rem 0.55rem; border-radius:0.5rem;">
              Due: {{ a[4] }}
            </span>
          </div>
          <p class="muted" style="margin:0; font-size:0.9rem;">Click to view details</p>
        </a>
      {% endfor %}
    </div>
  {% else %}
    <p class="muted" style="margin-top:0.5rem;">No assignments yet. Lucky you...</p>
  {% endif %}
</div>

  <div class="card">
    <h3>Class Messages</h3>
    {% if enrolled %}
      <form method="POST" action="{{ url_for('class_message', class_id=class_row[0]) }}" enctype="multipart/form-data" style="margin-bottom:1.5rem;">
        <textarea name="content" rows="3" placeholder="Write a message...! Say hi!" style="width:100%; padding:0.6rem; margin-bottom:0.5rem;"></textarea>
        <input type="file" name="image" accept="image/*" />
        <button class="btn" type="submit">Post message</button>
      </form>
    {% else %}
      <p class="muted">Only the class teacher or students can post messages!</p>
    {% endif %}
    <div style="margin-top:1rem;">
      {% if messages %}
        {% for m in messages %}
          <div class="message-bubble{% if m[2] == user.id %} own{% endif %}">
            <div style="display:flex;align-items:center;gap:0.7rem;">
              <img class="avatar small" src="{{ m[6] or url_for('static', filename='images/default_avatar.png') }}" alt="User" />
              <div>
                <span style="font-weight:700;">{{ m[5] }}</span>
                <span class="muted" style="font-size:0.97em;">- {{ m[4]|sydney_time }}</span>
              </div>
            </div>
            {% if m[7] %}
              <div style="margin:0.8em 0;">
                <img src="{{ m[7] }}" style="max-width:170px;max-height:110px;border-radius:12px;box-shadow:0 2px 12px #0f203433;" alt="Image" />
              </div>
            {% endif %}
            <div style="margin-top:6px;">{{ m[3] }}</div>
          </div>
        {% endfor %}
      {% else %}
        <p class="muted">No messages yet.</p>
      {% endif %}
    </div>
  </div>
  {% if user.role == "teacher" and user.id == teacher[0] %}
    <form method="post" action="{{ url_for('delete_class_route', class_id=class_row[0]) }}" onsubmit="return confirm('Delete this class?')" style="margin-top:1rem;">
      <button class="btn danger">Delete Class</button>
    </form>
    <a href="{{ url_for('edit_class', class_id=class_row[0]) }}" class="btn" style="margin-top:0.5rem;">Edit Class</a>
  {% elif user.role == "student" %}
    <form method="post" action="{{ url_for('unenroll_class', class_id=class_row[0]) }}" onsubmit="return confirm('Leave this class?')" style="margin-top:1rem;">
      <button class="btn danger">Unenroll</button>
    </form>
  {% endif %}
</div>
{% endblock %}