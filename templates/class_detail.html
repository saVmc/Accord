{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="page-header">
    <div>
      <h1>{{ class_row[1] }}</h1>
      <p class="muted">Code: {{ class_row[2] }}</p>
      <p class="muted">Teacher: {{ teacher[1] }} &lt;{{ teacher[2] }}&gt;</p>
    </div>
    <div>
      {% if user.role == 'teacher' and user.id == class_row[3] %}
        <a class="btn" href="{{ url_for('create_class') }}">+ New Class</a>
      {% endif %}
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Class Description</h3>
      <p class="muted">{{ class_row[4] or "No description yet." }}</p>

      {% if user.role == 'teacher' and user.id == class_row[3] %}
        <hr style="margin:12px 0">
        <form method="POST" action="{{ url_for('class_edit', class_id=class_row[0]) }}">
          <label>Change class name</label>
          <input name="class_name" type="text" value="{{ class_row[1] }}" />
          <label>Update description</label>
          <textarea name="description" rows="4">{{ class_row[4] or "" }}</textarea>
          <button class="btn" type="submit">Save changes</button>
        </form>
      {% endif %}
    </div>

    <div class="card">
      <h3>Students ({{ students|length }})</h3>
      {% if students %}
        <ul>
          {% for s in students %}
            <li>{{ s[1] }} — {{ s[2] }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="muted">No students enrolled yet.</p>
      {% endif %}
    </div>
  </div>

  <div style="margin-top:1.25rem;" class="card">
    <h3>Class Messages</h3>

    {% if enrolled %}
      <form method="POST" action="{{ url_for('class_message', class_id=class_row[0]) }}">
        <textarea name="content" rows="3" placeholder="Write a message..." style="width:100%; padding:0.6rem; margin-bottom:0.5rem;"></textarea>
        <button class="btn" type="submit">Post message</button>
      </form>
    {% else %}
      <p class="muted">Only the class teacher or enrolled students can post messages.</p>
    {% endif %}

    <div style="margin-top:1rem;">
      {% if messages %}
        {% for m in messages %}
          <div style="border-top:1px solid rgba(255,255,255,0.04); padding:0.6rem 0;">
            <div style="font-weight:700;">{{ m[5] }} <span class="muted" style="font-weight:400; font-size:0.9rem;"> — {{ m[4] }}</span></div>
            <div style="margin-top:6px;">{{ m[3] }}</div>
          </div>
        {% endfor %}
      {% else %}
        <p class="muted">No messages yet.</p>
      {% endif %}
    </div>
  </div>
</div>

  {% if user.role == "teacher" and user.userID == teacher[0] %}
    <form method="post" action="{{ url_for('delete_class_route', class_id=class_id) }}" onsubmit="return confirm('Delete this class?')" style="margin-top:1rem;">
      <button class="btn danger">Delete Class</button>
    </form>
    <a href="{{ url_for('edit_class', class_id=class_id) }}" class="btn" style="margin-top:0.5rem;">Edit Class</a>
  {% elif user.role == "student" %}
    <form method="post" action="{{ url_for('unenroll_class', class_id=class_id) }}" onsubmit="return confirm('Leave this class?')" style="margin-top:1rem;">
      <button class="btn danger">Unenroll</button>
    </form>
  {% endif %}

{% endblock %}