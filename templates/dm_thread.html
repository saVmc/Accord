{% extends "layout.html" %}
{% block content %}
<div class="page">
  <div class="dm-header">
    <div class="dm-header-left">
      <a href="{{ url_for('inbox') }}" class="back-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
      </a>
      <h1>{{ thread_name }}</h1>
      {% if participants|length > 2 %}
        <span class="participant-count">{{ participants|length }} members</span>
      {% endif %}
    </div>
    <div class="dm-header-actions">
      <button class="btn-icon" onclick="toggleRenameForm()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
      </button>
      <button class="btn-icon" onclick="toggleParticipants()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
      </button>
    </div>
  </div>

  <div id="renameForm" class="rename-container" style="display:none;">
    <form method="POST" action="{{ url_for('rename_dm', thread_id=thread_id) }}" class="rename-form-inline">
      <input type="text" name="new_name" placeholder="New conversation name" value="{{ thread_name }}" required />
      <button class="btn" type="submit">Rename</button>
      <button class="btn ghost" type="button" onclick="toggleRenameForm()">Cancel</button>
    </form>
  </div>

  <div id="participantsPanel" class="participants-panel" style="display:none;">
    <div class="card">
      <h3>Participants</h3>
      <div class="participants-grid">
        {% for p in participants %}
          <div class="participant-item">
            <img class="avatar" src="{{ p[3] or url_for('static', filename='images/default_avatar.png') }}" alt="Avatar" />
            <div class="participant-info">
              <strong>{{ p[1] }}</strong>
              <span class="muted">{{ p[2] }}</span>
            </div>
            {% if p[0] != user.id %}
              <a href="{{ url_for('start_dm', user_id=p[0]) }}" class="btn-small">Message</a>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="messages-container">
    <div class="messages-scroll" id="messagesScroll">
      {% if messages %}
        {% for m in messages %}
          <div class="message-item {% if m[2] == user.id %}own{% endif %}">
            {% if m[2] != user.id %}
              <img class="message-avatar" src="{{ m[7] or url_for('static', filename='images/default_avatar.png') }}" alt="User" />
            {% endif %}
            <div class="message-content">
              <div class="message-header">
                {% if m[2] != user.id %}
                  <span class="message-author">{{ m[6] }}</span>
                {% endif %}
                <span class="message-time">{{ m[5]|sydney_time }}</span>
              </div>
              {% if m[4] %}
                <div class="message-image">
                  <img src="{{ m[4] }}" alt="Image" onclick="openImageModal(this.src)" />
                </div>
              {% endif %}
              {% if m[3] %}
                <div class="message-text">{{ m[3] }}</div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% endif %}
    </div>

    <div class="message-input-container">
      <form method="POST" enctype="multipart/form-data" class="message-form">
        <div class="input-wrapper">
          <textarea name="content" rows="1" placeholder="Type a message..." id="messageInput" onkeydown="handleEnter(event)"></textarea>
          <label for="imageUpload" class="file-upload-label">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            <input type="file" name="image" accept="image/*" id="imageUpload" onchange="showFileName(this)" />
          </label>
          <button class="btn-send" type="submit">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
        <div id="fileName" class="file-name"></div>
      </form>
    </div>
  </div>
</div>

<div id="imageModal" class="image-modal" onclick="closeImageModal()">
  <span class="modal-close">&times;</span>
  <img class="modal-content" id="modalImage">
</div>

<script>
function toggleRenameForm() {
  const form = document.getElementById('renameForm');
  form.style.display = form.style.display === 'none' ? 'block' : 'none';
}

function toggleParticipants() {
  const panel = document.getElementById('participantsPanel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function handleEnter(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    event.target.form.submit();
  }
}

function showFileName(input) {
  const fileName = document.getElementById('fileName');
  if (input.files && input.files[0]) {
    fileName.textContent = 'Selected: ' + input.files[0].name;
  } else {
    fileName.textContent = '';
  }
}

function openImageModal(src) {
  const modal = document.getElementById('imageModal');
  const modalImg = document.getElementById('modalImage');
  modal.style.display = 'flex';
  modalImg.src = src;
}

function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}

// Auto-scroll to bottom on load
window.addEventListener('load', function() {
  const scroll = document.getElementById('messagesScroll');
  if (scroll) {
    scroll.scrollTop = scroll.scrollHeight;
  }
});

// Auto-resize textarea
const textarea = document.getElementById('messageInput');
if (textarea) {
  textarea.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = (this.scrollHeight) + 'px';
  });
}
</script>
{% endblock %}